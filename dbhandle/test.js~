//this module is for the mongoose db schema init first created at 2012-2-24

var mongoose = require('mongoose');
mongoose.connect('mongodb://localhost/project1');
var Schema = mongoose.Schema,
    ObjectId = Schema.ObjectId;


//用户：id,name,group,desc
var UserSchema = new Schema({
    usrname: String,
    group: Number,//0 stand for the admin,1 for the others
    collections: [BookSchema]
});

//图书：id,name,desc,img,detail,count
var BookSchema = new Schema({
    bookname: String,
    bookdesc: String,
    bookimg: [String],
    bookdetail: String,
    bookcount: Number
});

//书单:bookid,count
var OrderSchema = new Schema({
    bookid: ObjectId,
    count: Number
});

//订单列表:order
var OrderListSchema = new Schema({
    orderid: [OrderSchema]
});

UserSchema.method.init = function(obj){
    this.username = obj.username;
    this.group = obj.group;
};

UserSchema.statics.findByName = function(name, cb){
    return this.findOne({username: name},cb);
};






var User = mongoose.model('User', UserSchema);
var OrderList = mongoose.model('OrderList', OrderListSchema);

var createUser = function(obj, cb){
    var tmp = new User();
    tmp.init(obj);
    tmp.save(function(err){
        if(!err){
            console.log('save success');
            cb();
        }else{
            console.log('save failed');
            console.log('error:' + err);
        }
    });
};

var updateUser = function(id, obj, cb){
    var conditions = {_id: id},
        update = obj,
        options = {multi: false};
    User.update(conditions,update,options,callback);
    function callback(err,numAffected){
        if(!err){
            console.log('update success');
            cb();
        }else{
            console.log('update failed');
            console.log('error:' + err);
        }
    }
};

var removeUser = function(id,cb){
    var conditions = {_id: id};
    User.remove(conditions,callback);
    function callback(err){
        if(!err){
            console.log('remove success');
            cb();
        }else{
            console.log('remove failed');
            console.log('error:' + err);
        }
    }
};

var queryUser = function(name,cb){
    var conditions = {username: name};
    User.findOne(conditions,cb);
};

